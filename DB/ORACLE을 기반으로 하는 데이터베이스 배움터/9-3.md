# 회복

어떤 트랜잭션 T를 수행하는 도중에 시스템이 다운되었을 때, T의 수행 효과가 디스크의 데이터베이스에 일부 반영되었을 수 있다.  
어떻게 T의 수행을 취소하여 원자성을 보장할 것인가? 또한 트랜잭션 T가 종료된 직후에 시스템이 다운되면 T의 모든 갱신 효과가 주기억 장치로부터 디스크에 기록되지 않을 수 있다.  
어떻게 T의 수행 결과가 데이터베이스에 완전하게 반영되도록 하여 지속성을 보장할 것인가?  
디스크의 헤드 등이 고장 나서 디스크의 데이터베이스를 접근할 수 없다면 어떻게 할 것인가?

본 절에서는 이와 같은 물음들에 대한 해결 방안을 알아본다.  
어떤 이유로 DBMS가 다운되든지 DBMS의 회복 모듈은 트랜잭션의 원자성과 지속성을 보장해야 한다.



## 목차

- 회복의 개요
- 로그를 사용한 즉시 갱신
- 데이터베이스 백업과 재해적 고장으로부터의 회복



## 회복의 개요

어떤 응용1에서 데이터베이스 항목 X가 필요해서 디스크로부터 주기억 장치 버퍼로 읽어들이면, 응용2에서 동일한 데이터베이스 항목 X가 필요할 때  
디스크로부터 다시 읽을 필요가 없이 주기억 장치 내의 데이터베이스 항목 X를 사용하면 된다.  
또한 응용1에서 주기억 장치 내의 데이터베이스 항목 X를 갱신한 후에 응용2에서도 동일한 데이터베이스 항목 X를 갱신할 수 있으므로 응용1에서 X를 갱신한 후에 디스크에 즉시 기록할 필요는 없다.  
각 응용에서 어떤 데이터베이스 항목을 갱신할 때마다 즉시 디스크에 기록한다면 디스크 접근 회수가 크게 증가하여 성능이 저하될 수 있다.  
따라서 여러 응용이 주기억 장치 버퍼 내의 동일한 데이터베이스 항목을 갱신한 후에 디스크에 기록함으로써 성능을 향상시키는 것이 중요하다.

이처럼 주기억 장치의 버퍼는 디스크로부터 데이터를 읽거나 디스크에 데이터를 기록하는 비용을 최소화하기 위해서 완충 역할을 수행한다.  
버퍼의 내용을 디스크에 기록하는 것을 가능하면 최대한 줄이는 것이 일반적이다.  
예를 들어, 버퍼가 꽉 찼을 때 또는 트랜잭션이 완료될 때 버퍼의 내용이 디스크에 기록될 수 있다.

트랜잭션이 버퍼에는 갱신 사항을 반영했지만 버퍼의 내용이 디스크에 기록되기 전에 고장이 발생할 수 있다.  
이런 경우에 DBMS의 회복 모듈은 고장이 발생한 시점에 갱신을 수행한 트랜잭션들의 상태를 조사해야 한다.  
만일 고장이 발생하기 전에 트랜잭션이 완료 명령을 수행했다면 회복 모듈은 이 트랜잭션의 갱신 사항을 __재수행(REDO)__ 하여 트랜잭션의 갱신이 지속성을 갖도록 해야 한다.  
한편 고장이 발생하기 전에 트랜잭션이 완료 명령을 수행하지 못했다면 원자성을 보장하기 위해서 이 트랜잭션이 데이터베이스에 반영했을 가능성이 있는 갱신 사항을 __취소(UNDO)__ 해야 한다.

DBMS는 데이터베이스의 회복을 위해서 백업, 로깅, 체크포인트 등을 수행한다.  
__백업(backup)__ 은 데이터베이스를 주기적으로 자기 테이프 등에 복사하는 것이다.  
__로깅(logging)__ 은 현재 수행 중인 트랜잭션의 상태와 데이터베이스의 갱신 사항을 기록한다.  
__체크포인트(checkpoint)__ 는 시스템이 붕괴된 후 재기동되었을 때 재수행하거나 취소해야 하는 트랜잭션들의 수를 줄여준다.



:large_blue_circle:저장 장치의 유형

주기억 장치와 같은 휘발성 저장 장치에 들어 있는 내용은 시스템이 다운된 후에 모두 사라진다.  
이에 반해서 디스크와 같은 비휘발성 저장 장치에 들어 있는 내용은 디스크 헤드 등이 손상을 입지 않는 한 시스템이 다운된 후에도 유지된다.  
__안전 저장 장치(stable storage)__ 는 모든 유형의 고장을 견딜 수 있는 저장 장치를 의미한다.  
두 개 이상의 비휘발성 저장 장치가 동시에 고장 날 가능성이 매우 낮으므로 비휘발성 저장 장치에 두 개 이상의 사본을 중복해서 저장함으로써 안전 저장 장치를 구현한다.

디스크가 손상을 입어서 데이터베이스를 읽을 수 없는 고장을 __재해적 고장__ 이라 하고, 그 이외의 고장을 __비재해적 고장__ 이라고 한다.  
고장의 유형에 따라 회복 절차는 재해적 고장으로부터 회복과 비지해적 고장으로부터의 회복으로 분류된다.  
재해적 고장으로부터의 회복은 데이터베이스를 백업해놓은 자기 테이프를 기반으로 한다.  
대부분의 회복 알고리즘들은 비재해적 고장에 적용된다. 비재해적 고장으로부터의 회복은 __로그를 기반으로 한 즉시 갱신__,  
__로그를 기반으로 한 지연 갱신__, __그림자 페이징(shadow paging)__ 등 여러 알고리즘을 기반으로 한다.  
대부분의 상용 DBMS에서 로그를 기반으로 한 즉시 갱신 방식을 사용하므로 본 절에서는 여러 회복 기법들 중에서 이 기법만 논의한다.



## 로그를 사용한 즉시 갱신

